# 🔐 用户权限管理系统说明

## 功能概述

已实现完整的用户登录、角色权限和操作日志系统，确保数据安全和操作可追溯。

---

## 🚀 立即使用

### 首次登录

系统会自动创建默认管理员账号：

```
用户名: admin
密码: admin123
```

**⚠️ 重要：登录后请立即修改密码！**

---

## 👥 角色权限体系

### 1. 老板（OWNER）

**权限：** 全部权限 ✅

```
商品管理: ✅ 查看、添加、编辑、删除
库存管理: ✅ 查看、调整
销售管理: ✅ 查看、创建、作废、删除发票
财务管理: ✅ 查看、编辑、查看报表
客户供应商: ✅ 查看、编辑
系统管理: ✅ 用户管理、查看日志、导入导出数据
```

**适用于：** 公司老板、最高管理者

---

### 2. 经理（MANAGER）

**权限：** 大部分权限，不能管理用户 ⭐

```
商品管理: ✅ 查看、添加、编辑、删除
库存管理: ✅ 查看、调整
销售管理: ✅ 查看、创建、作废（❌ 不能永久删除）
财务管理: ✅ 查看、编辑、查看报表
客户供应商: ✅ 查看、编辑
系统管理: ✅ 查看日志、导出数据（❌ 不能管理用户、导入数据）
```

**适用于：** 店长、部门经理

---

### 3. 收银员（CASHIER）

**权限：** 开单、收款 💰

```
商品管理: ✅ 查看（❌ 不能添加、编辑、删除）
库存管理: ✅ 查看（❌ 不能调整）
销售管理: ✅ 查看、创建发票（❌ 不能作废、删除）
财务管理: ❌ 无权限
客户供应商: ✅ 查看、添加客户（❌ 不能查看供应商）
系统管理: ❌ 无权限
```

**适用于：** 前台收银员

---

### 4. 仓管员（WAREHOUSE）

**权限：** 库存管理 📦

```
商品管理: ✅ 查看、添加、编辑（❌ 不能删除）
库存管理: ✅ 查看、调整
销售管理: ✅ 查看发票（❌ 不能创建、作废）
财务管理: ❌ 无权限
客户供应商: ✅ 查看客户、查看编辑供应商
系统管理: ❌ 无权限
```

**适用于：** 仓库管理员

---

### 5. 普通员工（STAFF）

**权限：** 只能查看 👀

```
商品管理: ✅ 查看（❌ 不能修改）
库存管理: ✅ 查看（❌ 不能调整）
销售管理: ✅ 查看发票（❌ 不能创建）
财务管理: ❌ 无权限
客户供应商: ✅ 查看客户（❌ 不能修改）
系统管理: ❌ 无权限
```

**适用于：** 实习生、临时工

---

## 🎯 用户管理功能

### 访问路径

**系统管理 → 用户管理**

### 功能列表

#### 1. 查看用户列表

显示信息：
- 用户名（@username）
- 真实姓名
- 角色（带颜色标签）
- 联系方式
- 状态（启用/禁用）
- 最后登录时间

#### 2. 添加新用户

必填字段：
- ✅ 用户名（登录用）
- ✅ 密码（至少6位）
- ✅ 姓名（真实姓名）
- ✅ 角色（选择权限级别）

可选字段：
- 电话
- 邮箱

#### 3. 编辑用户

可修改：
- 姓名
- 角色（权限会自动更新）
- 电话
- 邮箱

不可修改：
- 用户名（登录名固定）

#### 4. 重置密码

**功能：** 管理员可为任何用户重置密码

**操作：**
1. 点击用户旁边的 🔑 图标
2. 输入新密码（至少6位）
3. 确认

**记录：** 会记录到操作日志

#### 5. 启用/禁用用户

**禁用效果：**
- 用户无法登录
- 显示为灰色半透明
- 状态显示"禁用"

**用途：** 员工离职、临时禁止访问

#### 6. 删除用户

**限制：**
- ❌ 不能删除当前登录用户
- ⚠️ 永久删除，不可恢复

**操作：** 需二次确认

---

## 📊 操作日志功能

### 访问路径

**系统管理 → 操作日志**

### 日志记录内容

#### 记录的操作类型

| 类型 | 说明 | 标签颜色 |
|------|------|---------|
| 登录 | 用户登录系统 | 紫色 |
| 登出 | 用户退出系统 | 灰色 |
| 创建 | 新建数据 | 绿色 |
| 更新 | 修改数据 | 蓝色 |
| 删除 | 删除数据 | 红色 |
| 作废 | 作废记录 | 橙色 |

#### 日志详细信息

每条日志包含：
- ⏰ 时间（精确到秒）
- 👤 操作人
- 🎯 操作类型
- 📦 模块（如：商品管理、发票、用户等）
- 🎪 目标（具体操作对象）
- 📝 描述（操作说明）

### 筛选功能

**筛选条件：**
- 📅 时间范围（开始日期 - 结束日期）
- 📦 模块（选择特定模块）
- 🎯 操作类型（登录/创建/更新等）
- 👤 用户（搜索用户名）

**默认显示：** 最近7天的日志

### 日志导出

**格式：** CSV文件

**内容：** 筛选后的所有日志

**文件名：** `操作日志_20241015_143000.csv`

**用途：** 
- 审计追溯
- 数据分析
- 报表制作

### 日志清理

**功能：** 清除30天前的旧日志

**操作：** 
1. 点击"清除旧日志"按钮
2. 确认（不可恢复）
3. 显示清除数量

**建议：** 定期清理，保持系统性能

---

## 🔐 登录流程

### 1. 访问系统

打开系统URL → 自动跳转到登录页

### 2. 登录界面

**输入：**
- 用户名
- 密码

**提示：**
- 显示默认管理员账号
- 提醒首次登录要改密码

### 3. 登录成功

**跳转：** 仪表盘首页

**显示：**
- 顶部右侧显示用户名
- 点击用户名显示下拉菜单
- 可查看角色和退出登录

**记录：** 登录操作记录到日志

### 4. 登录失败

**提示：** "用户名或密码错误"

**原因：**
- 用户名不存在
- 密码错误
- 账号已禁用

---

## 🛡️ 安全机制

### 1. 密码加密

**加密方式：** Base64 + 盐值

**存储：** 只存储加密后的密码

**验证：** 比对加密后的值

**⚠️ 注意：** 生产环境建议使用bcrypt等更安全的加密

### 2. 会话管理

**存储：** localStorage

**内容：** 当前登录用户信息

**过期：** 手动退出或清除缓存

**保护：** 路由守卫，未登录自动跳转

### 3. 权限检查

**实现：** `usePermission` Hook

**使用：**
```typescript
const canEditProduct = usePermission('editProduct');

{canEditProduct && (
  <button>编辑商品</button>
)}
```

**效果：** 无权限的按钮不显示

---

## 👤 用户界面元素

### 顶部用户菜单

**位置：** 右上角

**显示：**
- 👤 用户图标
- 用户姓名
- ▼ 下拉箭头

**点击展开：**
```
┌─────────────────┐
│ 张三             │
│ 经理             │
│ @zhangsan       │
├─────────────────┤
│ 🚪 退出登录     │
└─────────────────┘
```

### 退出登录

**操作：** 点击"退出登录"

**效果：**
1. 清除会话
2. 记录登出日志
3. 跳转到登录页

---

## 📝 操作示例

### 示例1：添加收银员

```
场景：新员工小李入职，担任收银员

操作步骤：
1. 以admin登录
2. 系统管理 → 用户管理
3. 点击"添加用户"
4. 填写：
   - 用户名: xiaoli
   - 密码: 123456
   - 姓名: 小李
   - 角色: 收银员
   - 电话: 012-3456789
5. 点击"保存"

结果：
✅ 小李账号创建成功
✅ 具有收银员权限
✅ 可以开单，但不能修改商品价格
✅ 操作记录到日志
```

### 示例2：查看谁删除了商品

```
场景：发现某个商品不见了，要查是谁删的

操作步骤：
1. 系统管理 → 操作日志
2. 筛选条件：
   - 模块: 商品管理
   - 操作类型: 删除
   - 时间范围: 最近7天
3. 查看结果

日志显示：
时间: 2024-10-15 14:30:25
用户: 张三
操作: 删除
模块: 商品管理
目标: 《三字经》
描述: 删除商品 《三字经》
```

### 示例3：员工离职禁用账号

```
场景：员工小王离职，需要禁用账号

操作步骤：
1. 系统管理 → 用户管理
2. 找到小王的账号
3. 点击状态切换按钮
4. "启用" → "禁用"

结果：
✅ 小王无法再登录
✅ 账号显示灰色
✅ 记录到操作日志
✅ 历史数据保留
```

---

## 🎨 界面展示

### 登录页面

```
┌────────────────────────────────┐
│                                │
│        🔐 半亩天光             │
│        企业管理系统             │
│                                │
│    ┌──────────────────┐       │
│    │ 用户名             │       │
│    └──────────────────┘       │
│    ┌──────────────────┐       │
│    │ 密码               │       │
│    └──────────────────┘       │
│                                │
│    [    🔐 登录    ]          │
│                                │
│    💡 首次使用默认账号：        │
│    用户名: admin               │
│    密码: admin123              │
│                                │
└────────────────────────────────┘
```

### 用户管理页面

```
┌─────────────────────────────────────┐
│ 👥 用户管理                [+ 添加用户]│
├─────────────────────────────────────┤
│ 用户名   姓名  角色    状态  最后登录 操作│
│─────────────────────────────────────│
│ @admin   管理员 老板   ✅启用  刚刚   ✏️🔑│
│ @zhangsan 张三  经理   ✅启用  1小时前 ✏️🔑🗑️│
│ @xiaoli  小李  收银员 ✅启用  今天   ✏️🔑🗑️│
│ @xiaowang 小王  仓管员 ❌禁用  3天前  ✏️🔑🗑️│
└─────────────────────────────────────┘
```

### 操作日志页面

```
┌─────────────────────────────────────┐
│ 📊 操作日志          [导出CSV][清理]│
├─────────────────────────────────────┤
│ 🔍 筛选：                           │
│ [开始日期] [结束日期] [模块▼] [操作▼]│
│ 显示 125 条记录（共 1,234 条）      │
├─────────────────────────────────────┤
│ 时间              用户  操作 模块  描述│
│─────────────────────────────────────│
│ 2024-10-15 15:30  张三  创建 发票  ...│
│ 2024-10-15 15:25  小李  登录 系统  ...│
│ 2024-10-15 15:20  张三  更新 商品  ...│
│ 2024-10-15 15:15  管理员 删除 客户  ...│
└─────────────────────────────────────┘
```

---

## 💡 最佳实践

### 1. 账号管理

**✅ 推荐：**
- 每个员工独立账号
- 根据职责分配角色
- 定期审查权限
- 员工离职及时禁用

**❌ 避免：**
- 多人共用一个账号
- 给普通员工老板权限
- 使用弱密码
- 不修改默认密码

### 2. 密码安全

**✅ 推荐：**
- 至少6位
- 包含字母+数字
- 定期更换
- 不使用生日、123456等

**❌ 避免：**
- 密码太简单
- 告诉别人密码
- 写在纸上

### 3. 权限分配

**按需分配原则：**
```
收银员: 只能开单收款 ✅
仓管员: 只管库存商品 ✅
经理: 可以查看报表 ✅
老板: 掌握全部数据 ✅
```

### 4. 日志审查

**建议频率：**
- 每天: 快速浏览异常操作
- 每周: 检查删除操作
- 每月: 全面审计

**重点关注：**
- ⚠️ 删除操作
- ⚠️ 大额修改
- ⚠️ 深夜操作
- ⚠️ 异常登录

---

## 🔧 常见问题

### Q1: 忘记admin密码怎么办？

**A:** 
1. 打开浏览器开发者工具（F12）
2. Application → IndexedDB → ERPSystem → users
3. 找到admin用户
4. 修改password字段为：`YWRtaW4xMjNzYWx0LWVycC0yMDI0` （admin123）
5. 刷新页面重新登录

### Q2: 如何修改自己的密码？

**A:** 
目前版本需要管理员帮忙重置。下一版本会添加"修改密码"功能。

### Q3: 能看到别人的操作吗？

**A:** 
- 老板/经理：可以查看所有人的操作日志
- 其他角色：无权限查看日志

### Q4: 日志会占用很多空间吗？

**A:** 
- 每条日志约500字节
- 1000条日志约0.5MB
- 建议每月清理一次

### Q5: 能限制某个用户只能看特定客户吗？

**A:** 
目前版本暂不支持，下一版本会增加更细粒度的权限控制。

---

## 🚀 下一步功能

计划实现（按优先级）：

### 1. 用户自主修改密码 ⭐⭐⭐⭐⭐
- 个人中心
- 修改密码
- 验证旧密码

### 2. 权限按钮显示/隐藏 ⭐⭐⭐⭐⭐
- 根据权限自动隐藏无权限按钮
- 提升用户体验

### 3. 操作审批流程 ⭐⭐⭐⭐
- 大额退款需审批
- 删除商品需审批
- 通知机制

### 4. 更细粒度权限 ⭐⭐⭐
- 自定义角色
- 单独设置每项权限
- 数据权限（只看自己的客户）

---

## 📞 技术支持

如有问题，请查看：
- 操作日志（系统管理 → 操作日志）
- 浏览器控制台（F12）
- 系统文档

---

**🎉 用户权限管理系统已就绪！**

**现在您的ERP系统具备：**
- ✅ 完整的用户登录
- ✅ 5级角色权限
- ✅ 操作日志追溯
- ✅ 安全可靠

**可以放心使用了！** 🚀

