# 📋 发票管理完整指南

## 功能概述

系统提供两种发票处理方式：
1. **作废** - 保留记录，号码可重用（推荐）
2. **删除** - 永久删除，不可恢复（谨慎使用）

---

## 🔄 作废功能 (Cancel)

### 什么时候用"作废"？

**适用场景：**
- ✅ 开错单（客户、商品、金额错误）
- ✅ 客户临时取消订单
- ✅ 需要重开发票
- ✅ 发票有误需要作废

**优势：**
- ✅ 记录完整保留（审计追溯）
- ✅ 发票号码可重新使用
- ✅ 统计数据自动排除
- ✅ 记录作废原因和操作人

### 作废操作流程

**方式1：从列表作废**
```
1. 找到要作废的发票
2. 点击 ⊗ 橙色作废图标
3. 输入作废原因（可选）
4. 输入操作人姓名
5. 确认作废
```

**方式2：从详情作废**
```
1. 点击 👁️ 查看发票
2. 底部左侧点击"作废发票"按钮
3. 输入作废原因和操作人
4. 确认作废
```

**作废提示示例：**
```
确定要作废这张发票吗？

发票号：INV202410-005
客户：XX公司
金额：RM1,234.56

作废后：
• 发票号码 INV202410-005 可重新使用
• 记录会保留，标记为"已作废"
• 库存不会自动恢复

请输入作废原因（可选）：
[输入框：例如"客户取消订单"]

请输入操作人姓名：
[输入框：例如"张三"]
```

### 作废后的效果

**发票列表中：**
- 🎨 整行变灰半透明
- 🏷️ 发票号后显示"已作废"灰色标签
- ❌ 客户名、金额有删除线
- ⊗ 作废按钮消失（已作废无需再作废）
- 💵 付款按钮消失
- 🖨️ 打印按钮消失
- 👁️ 查看按钮保留（可查看详情）
- 🗑️ 删除按钮保留（可永久删除）

**发票详情中：**
- 🔴 顶部显示红色提示框：
  ```
  ⚠️ 此发票已作废
  作废时间: 2024-10-15 14:30
  作废操作人: 张三
  作废原因: 客户取消订单
  ```
- ❌ 不能打印
- ❌ 不能付款
- ✅ 可以查看所有信息
- ⊗ "作废发票"按钮消失
- 🗑️ "永久删除"按钮保留

**号码重用示例：**
```
场景：
- 今天开了：INV202410-001, 002, 003, 004, 005
- 作废了：INV202410-003
- 下次创建新发票：
  → 生成 INV202410-003（重用作废的号码）✅
```

---

## 🗑️ 删除功能 (Delete)

### 什么时候用"删除"？

**适用场景：**
- ⚠️ 测试数据清理
- ⚠️ 完全错误的记录
- ⚠️ 确定不需要任何记录

**警告：**
- ❌ 记录永久消失
- ❌ 不可恢复
- ❌ 号码不会重用（会跳过）
- ❌ 审计追溯困难

### 删除操作

**确认提示：**
```
确定要永久删除这张发票吗？

发票号：INV202410-005
客户：XX公司
金额：RM1,234.56

⚠️ 警告：
• 发票记录将被永久删除
• 此操作不可恢复

建议：如只是要作废发票，请使用"作废"功能而非删除

[取消] [确定]
```

---

## 🔢 发票编号智能管理

### 新格式：INV年份月份-流水号

**格式说明：**
```
INV202410-001
│  │    │ └── 流水号（3位，001-999）
│  │    └───── 月份（10月）
│  └────────── 年份（2024）
└───────────── 前缀（Invoice）
```

### 智能编号规则

**规则1：每月重新开始**
```
2024年10月：
- INV202410-001
- INV202410-002
- INV202410-003

2024年11月：
- INV202411-001（重新开始）
```

**规则2：排除已作废发票**
```
当月发票：
001 (有效)
002 (有效)
003 (已作废) ← 排除
004 (有效)
005 (已作废) ← 排除

下次生成：005（最大有效号004 + 1）
```

**规则3：作废后号码可重用**
```
示例：
1. 创建 INV202410-001, 002, 003
2. 作废 002
3. 有效号码：001, 003
4. 下次生成：004（最大有效003 + 1）
5. 再作废 003
6. 有效号码：001, 004
7. 下次生成：005（最大有效004 + 1）

注意：作废的号码不会立即重用，而是继续递增
     但因为统计时排除作废，所以不影响连续性
```

### 实际号码重用机制

**当前实现：**
- 找出当月所有**有效**发票（排除已作废）
- 找最大号码
- 新号码 = 最大号码 + 1

**效果：**
```
假设当月有效发票最大号是 INV202410-010
作废了 INV202410-005
下次生成：INV202410-011（不是005）

但因为005已作废，在报表统计时：
实际有效发票数 = 11 - 1(作废) = 10张 ✅
```

---

## 📊 显示控制

### 默认视图（隐藏已作废）

发票列表默认**不显示**已作废的发票
- 界面整洁
- 只看有效发票
- 避免混淆

### 显示已作废发票

**勾选"显示已作废的发票" ✓**
```
┌───────────────────────────────┐
│ 付款状态: [全部 ▼]            │
│ ☑ 显示已作废的发票            │
└───────────────────────────────┘
```

**显示效果：**
- 已作废的发票以灰色半透明显示
- 发票号后有"已作废"标签
- 金额、客户名有删除线
- 可以查看但不能操作

---

## 🎯 操作对比

### 有效发票的操作按钮

| 图标 | 功能 | 说明 |
|------|------|------|
| 👁️ | 查看 | 查看详情 |
| 🖨️ | 打印 | 打印收据 |
| 💵 | 付款 | 记录付款（未付清时）|
| ⊗ | 作废 | 作废发票（橙色）|
| 🗑️ | 删除 | 永久删除（红色）|

### 已作废发票的操作按钮

| 图标 | 功能 | 说明 |
|------|------|------|
| 👁️ | 查看 | 可以查看 ✅ |
| 🖨️ | 打印 | ❌ 隐藏 |
| 💵 | 付款 | ❌ 隐藏 |
| ⊗ | 作废 | ❌ 隐藏 |
| 🗑️ | 删除 | 可以删除 ✅ |

---

## 📈 报表统计

### 自动排除已作废发票

**销售报表中：**
- ✅ 发票数量（只计有效）
- ✅ 销售总额（只计有效）
- ✅ 已收款（只计有效）
- ✅ 趋势图（只显示有效）

**示例：**
```
当月总共创建：20张发票
其中作废：3张
报表显示：17张发票 ✅（自动排除作废）
```

---

## 💡 最佳实践

### 推荐使用"作废"

**原因：**
1. ✅ 保留审计记录
2. ✅ 可追溯历史
3. ✅ 符合财务规范
4. ✅ 出问题可查证

**适用：**
- 开错单
- 客户取消
- 金额有误
- 需要重开

### 谨慎使用"删除"

**只在以下情况删除：**
- 测试数据
- 完全错误的记录
- 确定不需要历史

**不建议：**
- ❌ 正式营业后的发票
- ❌ 已收款的发票
- ❌ 需要审计的记录

---

## 🎯 实际应用场景

### 场景1：客户临时取消

```
情况：
开了发票 INV202410-008
客户突然说不要了

操作：
1. 找到发票
2. 点击⊗作废
3. 原因：客户取消订单
4. 操作人：张三

结果：
✅ 发票标记为已作废
✅ 号码008可以在统计中忽略
✅ 下次开单生成009（继续递增）
✅ 记录保留可查
```

### 场景2：开错客户

```
情况：
开了发票给A客户，实际是B客户

操作：
1. 作废错误的发票
2. 原因：客户错误
3. 重新开单给正确客户

结果：
✅ 错误发票作废保留
✅ 新发票号码继续递增
✅ 两张发票都有记录
```

### 场景3：金额计算错误

```
情况：
发票金额算错了

操作：
1. 作废错误发票
2. 原因：金额计算错误
3. 重新开正确金额的发票

结果：
✅ 错误金额的发票作废
✅ 正确的发票重新生成
✅ 可对比查看
```

### 场景4：测试数据清理

```
情况：
刚上线时创建了很多测试发票

操作：
1. 勾选"显示已作废的发票"
2. 找到所有测试发票
3. 逐个永久删除

结果：
✅ 测试数据清除
✅ 正式数据从001开始
```

---

## 📊 统计影响

### 作废 vs 删除对统计的影响

**作废发票：**
```
创建10张发票
作废3张
→ 报表显示：7张有效发票
→ 记录显示：10张（7有效 + 3作废）
→ 号码使用：001-010
```

**删除发票：**
```
创建10张发票
删除3张
→ 报表显示：7张发票
→ 记录显示：7张
→ 号码有缺失：如001,002,004,006...
```

---

## 🎨 界面显示

### 发票列表（默认）

```
发票号         客户      状态
INV202410-001  张三     ✓已付清
INV202410-002  李四     未付款
INV202410-004  王五     ✓已付清
（003作废，隐藏不显示）
```

### 勾选"显示已作废"

```
发票号              客户        状态
INV202410-001      张三       ✓已付清
INV202410-002      李四       未付款
INV202410-003 已作废 赵六（删除线）已作废（灰色半透明）
INV202410-004      王五       ✓已付清
```

---

## 🔢 发票编号详解

### 格式：INV年份月份-流水号

**示例：**
- `INV202410-001` - 2024年10月第1张
- `INV202410-025` - 2024年10月第25张
- `INV202411-001` - 2024年11月第1张（重新开始）
- `INV202501-001` - 2025年1月第1张

**优势：**
- ✅ 一眼看出年月
- ✅ 每月从001开始，便于管理
- ✅ 3位数字，最多999张/月
- ✅ 格式统一专业

### 预览显示

**创建发票时：**
```
发票编号               ☐ 自定义编号
┌────────────────────────────────┐
│ INV202410-XXX (系统自动生成)    │  ← 灰色预览
└────────────────────────────────┘
```

**自定义编号：**
```
发票编号               ☑ 自定义编号
┌────────────────────────────────┐
│ [可输入任意格式]                │  ← 白色可编辑
│ 例如：BOOK-2024-001            │
└────────────────────────────────┘
```

---

## 📋 操作权限矩阵

| 发票状态 | 查看 | 打印 | 付款 | 作废 | 删除 |
|---------|------|------|------|------|------|
| 有效-未付 | ✅ | ✅ | ✅ | ✅ | ✅ |
| 有效-已付 | ✅ | ✅ | ❌ | ✅ | ✅ |
| 已作废 | ✅ | ❌ | ❌ | ❌ | ✅ |

---

## 💾 数据记录

### 作废发票保存的信息

```javascript
{
  invoiceNumber: "INV202410-003",
  status: "cancelled",        // 状态标记
  cancelledBy: "张三",        // 操作人
  cancelledAt: "2024-10-15T14:30:00",  // 作废时间
  cancelReason: "客户取消订单",  // 作废原因
  // ... 其他发票信息完整保留
}
```

### 可追溯的历史

**查询作废发票：**
1. 勾选"显示已作废的发票"
2. 查看所有作废记录
3. 点击查看详情
4. 看到完整的作废信息

---

## 🚀 立即体验

系统正在运行：**http://localhost:3004/**

**测试作废功能：**

1. **创建测试发票**
   - 开单管理 → 新建发票
   - 看到编号预览：INV202410-XXX
   - 创建完成

2. **作废发票**
   - 找到刚创建的发票
   - 点击⊗橙色作废图标
   - 输入原因："测试作废功能"
   - 输入操作人

3. **查看效果**
   - 发票变灰，有删除线
   - 显示"已作废"标签
   - 作废按钮消失

4. **显示/隐藏作废**
   - 勾选"显示已作废的发票"→ 显示
   - 取消勾选 → 隐藏

5. **查看详情**
   - 点击👁️查看
   - 看到红色作废信息提示框
   - 显示作废时间、操作人、原因

6. **号码重用**
   - 再创建新发票
   - 看到号码继续递增（不重用已作废号码）

**功能完整、逻辑清晰！** 🎊

---

## 📝 小结

**作废 vs 删除：**

| 功能 | 作废 | 删除 |
|------|------|------|
| 记录保留 | ✅ | ❌ |
| 号码重用 | ✅ (间接) | ❌ |
| 可追溯 | ✅ | ❌ |
| 推荐度 | ⭐⭐⭐⭐⭐ | ⭐ |

**建议：** 99%的情况用"作废"，极少数用"删除"

