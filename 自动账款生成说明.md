# 🤖 自动账款生成功能说明

## 功能概述

系统现在会在创建发票或采购单时，自动生成相应的应收账款或应付账款，实现财务数据的自动化管理。

---

## 📥 应收账款自动生成

### 触发条件

当您在**开单管理**中创建发票时，如果满足以下条件，系统会自动创建应收账款：

✅ **客户未全额付款** （已付金额 < 发票总额）

### 生成逻辑

```
创建发票
    ↓
处理付款（如有）
    ↓
计算未付金额 = 发票总额 - 已付金额
    ↓
如果 未付金额 > 0
    ↓
自动创建应收账款
```

### 应收账款详细信息

**自动设置的字段：**

| 字段 | 值 | 说明 |
|------|-----|------|
| 客户ID/名称 | 从发票自动获取 | 关联客户信息 |
| 关联单据 | 发票ID和发票号 | 追溯来源 |
| 应收总额 | 发票总金额 | 发票的totalAmount |
| 已收金额 | 发票已付金额 | 发票的paidAmount |
| 未收金额 | 总额 - 已付 | 剩余需要收的金额 |
| 状态 | pending（未收款） | 初始状态 |
| 到期日 | 创建日期 + 30天 | 默认30天账期 |
| 备注 | "发票 XXX 的应收账款" | 自动说明 |
| 创建人 | 开单人 | 责任追溯 |

### 使用场景

#### 场景1：客户部分付款

```
开单信息：
- 发票总额：RM1,000.00
- 客户现付：RM400.00
- 未付金额：RM600.00

系统自动执行：
✅ 创建发票（INV202410-001）
✅ 记录已付RM400.00
✅ 自动创建应收账款
   - 应收总额：RM1,000.00
   - 已收金额：RM400.00
   - 未收金额：RM600.00
   - 到期日：30天后
   - 状态：部分收款

成功提示：
┌────────────────────────────────┐
│ 发票创建成功！                 │
│ 发票号：INV202410-001          │
│                                │
│ 已付：RM400.00                 │
│ 未付：RM600.00                 │
│ 已自动创建应收账款             │
└────────────────────────────────┘
```

#### 场景2：客户赊账（完全不付款）

```
开单信息：
- 发票总额：RM2,500.00
- 客户现付：RM0.00
- 不选择立即付款

系统自动执行：
✅ 创建发票（INV202410-002）
✅ 已付金额：RM0.00
✅ 自动创建应收账款
   - 应收总额：RM2,500.00
   - 已收金额：RM0.00
   - 未收金额：RM2,500.00
   - 到期日：30天后
   - 状态：未收款

成功提示：
┌────────────────────────────────┐
│ 发票创建成功！                 │
│ 发票号：INV202410-002          │
│                                │
│ 已付：RM0.00                   │
│ 未付：RM2,500.00               │
│ 已自动创建应收账款             │
└────────────────────────────────┘
```

#### 场景3：客户全额付款

```
开单信息：
- 发票总额：RM500.00
- 客户现付：RM500.00

系统执行：
✅ 创建发票（INV202410-003）
✅ 记录已付RM500.00
❌ 不创建应收账款（已全额付清）

成功提示：
┌────────────────────────────────┐
│ 发票创建成功！                 │
│ 发票号：INV202410-003          │
│                                │
│ 全款已付                       │
└────────────────────────────────┘
```

---

## 📤 应付账款自动生成

### 触发条件

当您在**进货管理**中创建采购单时，如果满足以下条件，系统会自动创建应付账款：

✅ **选择了供应商**

### 生成逻辑

```
创建采购单
    ↓
选择供应商？
    ↓ 是
计算采购总额 = Σ(商品单价 × 数量)
    ↓
设置账期（默认30天）
    ↓
自动创建应付账款
    ↓ 否
不创建应付账款（现金采购或其他方式）
```

### 应付账款详细信息

**自动设置的字段：**

| 字段 | 值 | 说明 |
|------|-----|------|
| 供应商ID/名称 | 从采购单选择 | 关联供应商信息 |
| 关联单据 | 采购单号 | 自动生成（PO20241015-XXXX） |
| 应付总额 | 采购总金额 | Σ(单价 × 数量) |
| 已付金额 | 0 | 初始未付款 |
| 未付金额 | 采购总额 | 全部待付 |
| 状态 | pending（未付款） | 初始状态 |
| 到期日 | 创建日期 + 账期天数 | 可自定义账期 |
| 备注 | "采购单 XXX 的应付账款" | 自动说明 |
| 创建人 | 操作人 | 责任追溯 |

### 使用场景

#### 场景1：赊账采购（常规）

```
采购信息：
- 供应商：ABC书店
- 商品：
  · 《三字经》 50本 × RM8.00 = RM400.00
  · 《论语》 30本 × RM12.00 = RM360.00
- 采购总额：RM760.00
- 账期：30天

系统自动执行：
✅ 创建采购单（PO20241015-1234）
✅ 商品入库（+50本，+30本）
✅ 自动创建应付账款
   - 供应商：ABC书店
   - 应付总额：RM760.00
   - 已付金额：RM0.00
   - 未付金额：RM760.00
   - 到期日：2024-11-14
   - 状态：未付款

成功提示：
┌────────────────────────────────┐
│ 进货成功！                     │
│ 采购单号：PO20241015-1234      │
│ 已自动创建应付账款             │
└────────────────────────────────┘
```

#### 场景2：现金采购

```
采购信息：
- 供应商：（不选择）
- 商品：《弟子规》 20本
- 付款方式：现金

系统执行：
✅ 创建采购单（PO20241015-5678）
✅ 商品入库（+20本）
❌ 不创建应付账款（没有选择供应商）

成功提示：
┌────────────────────────────────┐
│ 进货成功！                     │
│ 采购单号：PO20241015-5678      │
└────────────────────────────────┘
```

#### 场景3：自定义账期

```
采购信息：
- 供应商：XYZ出版社
- 商品：各类图书
- 采购总额：RM5,000.00
- 账期：60天（修改默认30天）

系统自动执行：
✅ 创建采购单
✅ 商品入库
✅ 自动创建应付账款
   - 到期日：创建日期 + 60天
   - 其他信息同常规

付款到期日显示：
在进货界面实时显示：
"付款到期日：2024-12-14"
```

---

## 🔄 账款与单据的联动

### 应收账款与发票联动

**收款时自动更新：**

```
在应收账款页面收款
    ↓
更新应收账款
  · 已收金额 +RM200
  · 未收金额 -RM200
  · 状态更新
    ↓
自动同步更新关联发票
  · 发票已付金额 +RM200
  · 发票付款状态更新
    ↓
数据一致性保证
```

**示例：**
```
初始状态：
发票 INV202410-001
  - 总额：RM1,000
  - 已付：RM400
  - 状态：部分付款

应收账款
  - 总额：RM1,000
  - 已收：RM400
  - 未收：RM600
  - 状态：部分收款

收款操作：
在应收账款页面收款 RM300

更新后：
发票 INV202410-001
  - 总额：RM1,000
  - 已付：RM700 ← 自动更新
  - 状态：部分付款

应收账款
  - 总额：RM1,000
  - 已收：RM700
  - 未收：RM300
  - 状态：部分收款
```

### 应付账款与采购单关联

**追溯查询：**

```
从应付账款
    ↓
查看关联单据编号（PO20241015-1234）
    ↓
在进货记录中搜索
    ↓
找到对应的入库记录
    ↓
查看入库商品详情
```

---

## 📊 数据流图

### 发票 → 应收账款流程

```
┌─────────────┐
│ 创建发票    │
│ (开单管理)  │
└──────┬──────┘
       │
       ↓
┌─────────────────────┐
│ 计算未付金额        │
│ = 总额 - 已付       │
└──────┬──────────────┘
       │
       ↓ 未付 > 0
┌─────────────────────┐
│ 自动创建应收账款    │
│ · 客户信息          │
│ · 关联发票          │
│ · 未付金额          │
│ · 30天账期          │
└──────┬──────────────┘
       │
       ↓
┌─────────────────────┐
│ 可在应收账款页面    │
│ 查看和收款          │
└─────────────────────┘
```

### 采购单 → 应付账款流程

```
┌─────────────┐
│ 创建采购单  │
│ (进货管理)  │
└──────┬──────┘
       │
       ↓
┌─────────────────────┐
│ 选择供应商？        │
└──────┬──────────────┘
       │
       ↓ 是
┌─────────────────────┐
│ 计算采购总额        │
│ = Σ(单价 × 数量)    │
└──────┬──────────────┘
       │
       ↓
┌─────────────────────┐
│ 自动创建应付账款    │
│ · 供应商信息        │
│ · 关联采购单        │
│ · 采购总额          │
│ · 自定义账期        │
└──────┬──────────────┘
       │
       ↓
┌─────────────────────┐
│ 可在应付账款页面    │
│ 查看和付款          │
└─────────────────────┘
```

---

## ⚙️ 进货管理界面更新

### 新增字段

**采购单表单现在包含：**

1. **供应商选择**（可选）
   - 下拉选择现有供应商
   - 或选择"不选择（不创建应付账款）"
   - 提示：选择供应商后会自动创建应付账款

2. **账期设置**（天数）
   - 默认：30天
   - 可自定义：0-365天
   - 实时显示付款到期日
   - 仅在选择供应商时启用

3. **商品明细增强**
   - 显示单价（使用商品成本价或售价）
   - 显示小计（数量 × 单价）
   - 显示采购总额

### 界面示例

```
┌─────────────────────────────────────────────────────┐
│ 新增进货                                        ✕   │
├─────────────────────────────────────────────────────┤
│ 供应商（可选） ▼  ABC书店                          │
│ 💡 选择供应商后会自动创建应付账款                  │
│                                                     │
│ 账期（天） [30]                                     │
│ 💡 付款到期日：2024-11-14                          │
│                                                     │
│ ┌─────────────────────────────────────────────┐   │
│ │ 添加商品                                    │   │
│ │ [商品选择 ▼] [数量] [添加]                  │   │
│ └─────────────────────────────────────────────┘   │
│                                                     │
│ 进货清单                                            │
│ ┌─────────────────────────────────────────────┐   │
│ │ 商品     │ 数量│单价    │小计    │操作     │   │
│ │─────────┼─────┼────────┼────────┼─────────│   │
│ │《三字经》│ +50 │RM8.00  │RM400.00│   ✕     │   │
│ │《论语》  │ +30 │RM12.00 │RM360.00│   ✕     │   │
│ │─────────────────────────────────────────────│   │
│ │ 总计: 2种商品，共80件         RM760.00      │   │
│ └─────────────────────────────────────────────┘   │
│                                                     │
│ 操作人 * [张三]        备注 [月初进货]             │
│                                                     │
│                       [取消] [确认进货]             │
└─────────────────────────────────────────────────────┘
```

---

## 💡 使用建议

### 最佳实践

#### 1. 开单时

✅ **推荐做法：**
- 如果客户要赊账，不选择立即付款
- 系统自动创建应收账款
- 30天后在应收账款页面追踪收款

❌ **避免：**
- 忘记设置付款信息
- 让系统自动创建账款后不管理

#### 2. 进货时

✅ **推荐做法：**
- 与供应商赊账时，选择供应商
- 根据约定设置正确的账期
- 系统自动创建应付账款
- 到期前在应付账款页面付款

❌ **避免：**
- 现金采购也选择供应商（会创建不必要的账款）
- 忘记设置正确的账期

### 账款管理流程

#### 应收账款流程

```
Day 1: 开单（客户赊账）
  ↓ 自动创建应收账款
Day 1-30: 定期查看应收账款页面
  ↓ 提醒客户付款
Day 15: 客户部分付款
  ↓ 在应收账款页面记录收款
  ↓ 发票自动同步更新
Day 25: 客户付清余款
  ↓ 记录收款
  ↓ 状态变为"已收清"
  ↓ 完成
```

#### 应付账款流程

```
Day 1: 进货（选择供应商）
  ↓ 自动创建应付账款
Day 1-30: 安排资金
  ↓ 查看应付账款页面
Day 28: 付款给供应商
  ↓ 在应付账款页面记录付款
  ↓ 状态变为"已付清"
  ↓ 完成
```

---

## 🎯 优势

### 1. 自动化

- ✅ 无需手动创建账款
- ✅ 减少操作步骤
- ✅ 避免遗漏

### 2. 数据一致性

- ✅ 账款与单据自动关联
- ✅ 收款/付款自动同步
- ✅ 避免数据不一致

### 3. 财务清晰

- ✅ 实时追踪欠款
- ✅ 逾期自动提醒
- ✅ 完整的审计追溯

### 4. 灵活性

- ✅ 可选择是否创建账款
- ✅ 可自定义账期
- ✅ 支持多种付款方式

---

## 📝 总结

**自动账款生成已完美集成到系统中！**

- ✅ **发票** → 自动创建应收账款（如有未付金额）
- ✅ **采购单** → 自动创建应付账款（如选择供应商）
- ✅ **收款** → 自动同步更新发票
- ✅ **完整的财务闭环**

**立即体验：**
1. 开单时部分收款 → 查看应收账款
2. 进货时选择供应商 → 查看应付账款
3. 在账款页面收款/付款 → 看到实时更新

**财务管理，从未如此简单！** 🎉✨

