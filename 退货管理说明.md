# 🔄 退货管理系统说明

## 功能概述

完整的退货/退款管理系统，支持退货单创建、审批流程、库存恢复和退款记录。

---

## 🎯 核心功能

### 1. 创建退货单
- 从发票选择退货
- 灵活选择退货商品和数量
- 区分退货数量和入库数量
- 必填退货原因

### 2. 退货审批
- 待审批→已批准→已完成
- 可以拒绝退货（记录原因）
- 审批人和时间记录

### 3. 库存恢复
- 自动恢复商品库存
- 记录库存变动
- 支持部分入库（商品损坏）

### 4. 退款管理
- 自动计算退款金额
- 更新发票已付金额
- 完整的退款记录

---

## 🚀 使用流程

### 步骤1：创建退货单

**操作路径：** 交易管理 → 退货管理 → 创建退货单

#### 1.1 选择发票
```
点击"创建退货单"
→ 从列表中选择要退货的发票
→ 只显示有效的、已付款的发票
```

**可选发票条件：**
- ✅ 发票状态：有效（非作废）
- ✅ 付款状态：已付款（paidAmount > 0）
- ✅ 显示：发票号、客户、商品数量、总额、日期

#### 1.2 选择退货商品

**退货商品表格：**
| 商品 | 原购买数量 | 退货数量 | 入库数量 | 单价 | 退款金额 |
|------|-----------|---------|---------|------|---------|
| 《三字经》 | 10 | 5 ↕️ | 5 ↕️ | RM10.00 | RM50.00 |
| 《论语》 | 5 | 2 ↕️ | 1 ↕️ | RM15.00 | RM30.00 |

**字段说明：**
- **退货数量**：客户要退的数量（不能超过原购买数量）
- **入库数量**：实际能重新入库的数量（可以少于退货数量）

**使用场景：**
```
场景：客户退回10本书，其中2本有损坏

操作：
- 退货数量：10
- 入库数量：8（损坏的2本不入库）

结果：
- 客户退款：10本的钱
- 库存增加：8本
```

#### 1.3 填写退货信息

**必填字段：**
- ✅ 退货原因（必须填写）
  - 示例："商品有质量问题"
  - 示例："客户不满意"
  - 示例："订单错误"

**可选字段：**
- 备注（其他补充说明）

**退款总额显示：**
```
┌─────────────────────────────────┐
│ 退款总额: RM80.00                │
│ (自动计算所有退货商品的金额)     │
└─────────────────────────────────┘
```

#### 1.4 提交创建

**点击"创建退货单"** → 系统自动：
1. ✅ 生成退货单号（RF202410-001）
2. ✅ 状态设为"待审批"
3. ✅ 记录创建人和时间
4. ✅ 记录到操作日志

---

### 步骤2：审批退货单

**操作路径：** 退货管理 → 找到待审批的退货单

**权限要求：**
- 老板/经理：可以审批
- 收银员：不能审批
- 仓管员：不能审批

#### 2.1 批准退货

**操作：** 点击 ✅ 绿色"批准"图标

**系统执行：**
1. 状态：待审批 → 已批准
2. 记录审批人：张三
3. 记录审批时间：2024-10-15 14:30
4. 记录到操作日志

**提示：**
```
✅ 退货单已批准！

下一步：等待仓管完成退货入库
```

#### 2.2 拒绝退货

**操作：** 点击 ❌ 红色"拒绝"图标

**输入拒绝原因：**
```
请输入拒绝原因:
[商品已超过退货期限]
```

**系统执行：**
1. 状态：待审批 → 已拒绝
2. 拒绝原因追加到备注
3. 记录到操作日志
4. 不会恢复库存
5. 不会退款

---

### 步骤3：完成退货

**操作路径：** 退货管理 → 找到已批准的退货单

**权限要求：**
- 老板/经理：可以完成
- 仓管员：可以完成（负责实际入库）
- 收银员：不能完成

#### 3.1 执行完成

**操作：** 点击 📦 蓝色"完成退货"图标

**确认提示：**
```
确定完成退货单 RF202410-001 吗？

将执行以下操作：
- 恢复库存
- 记录退款

[取消]  [确定]
```

#### 3.2 系统自动执行

**1. 恢复库存**
```
对于每个退货商品：
- 读取商品当前库存
- 增加入库数量
- 更新商品库存
- 记录库存变动（类型：退货入库）

示例：
《三字经》：库存 50 → 55（+5）
《论语》：库存 30 → 31（+1）
```

**2. 记录库存变动**
```
创建库存交易记录：
- 类型：退货入库
- 数量：5
- 变动前：50
- 变动后：55
- 关联：RF202410-001
- 操作人：仓管员
```

**3. 更新发票**
```
修改原发票的已付金额：
原已付：RM100.00
退款：RM80.00
新已付：RM20.00

(如果全部退款，已付金额变为0)
```

**4. 更新退货单状态**
```
状态：已批准 → 已完成
```

**5. 记录操作日志**
```
模块：退货管理
操作：更新
描述：完成退货单 RF202410-001，恢复库存，退款 RM80.00
```

#### 3.3 完成提示

```
✅ 退货单已完成！

已执行：
- ✓ 库存已恢复
- ✓ 退款已记录
- ✓ 发票已更新
```

---

## 📋 退货单状态流转

```
创建退货单
    ↓
[待审批] pending
    ↓
审批→批准/拒绝
    ↓           ↓
[已批准]    [已拒绝]
 approved    rejected
    ↓           (结束)
完成退货
    ↓
[已完成]
 completed
```

**状态说明：**

| 状态 | 颜色 | 说明 | 可操作 |
|------|------|------|--------|
| 待审批 | 黄色 | 刚创建，等待审批 | 批准、拒绝 |
| 已批准 | 蓝色 | 审批通过，等待入库 | 完成退货 |
| 已拒绝 | 红色 | 审批未通过 | 只能查看 |
| 已完成 | 绿色 | 已恢复库存和退款 | 只能查看 |

---

## 🎨 界面展示

### 退货单列表

```
┌───────────────────────────────────────────────────────────────────┐
│ 🔄 退货管理                          [创建退货单]                 │
├───────────────────────────────────────────────────────────────────┤
│ 状态: [全部 ▼]  共 15 条退货单                                    │
├───────────────────────────────────────────────────────────────────┤
│ 退货单号       发票       客户    退款金额  状态      创建时间  操作│
│───────────────────────────────────────────────────────────────────│
│ RF202410-001  INV...-001  张三   RM80.00  [待审批]  今天 10:00  👁️✅❌│
│ RF202410-002  INV...-005  李四   RM120.00 [已批准]  昨天      👁️📦│
│ RF202410-003  INV...-003  王五   RM50.00  [已完成]  3天前     👁️  │
│ RF202410-004  INV...-007  赵六   RM200.00 [已拒绝]  1周前     👁️  │
└───────────────────────────────────────────────────────────────────┘
```

### 创建退货单 - 步骤1（选择发票）

```
┌───────────────────────────────────────────────────────┐
│ 创建退货单                                        ✕   │
├───────────────────────────────────────────────────────┤
│ 请选择要退货的发票：                                  │
│                                                       │
│ ┌─────────────────────────────────────────────┐     │
│ │ INV202410-001                    2024-10-15 │     │
│ │ 张三                                         │     │
│ │ 5 件商品 | 总额: RM100.00                   │     │
│ └─────────────────────────────────────────────┘     │
│                                                       │
│ ┌─────────────────────────────────────────────┐     │
│ │ INV202410-005                    2024-10-14 │     │
│ │ 李四                                         │     │
│ │ 3 件商品 | 总额: RM150.00                   │     │
│ └─────────────────────────────────────────────┘     │
│                                                       │
│                              [取消]                   │
└───────────────────────────────────────────────────────┘
```

### 创建退货单 - 步骤2（填写退货信息）

```
┌──────────────────────────────────────────────────────────────────┐
│ 创建退货单                                                   ✕   │
├──────────────────────────────────────────────────────────────────┤
│ 发票号: INV202410-001    客户: 张三                              │
├──────────────────────────────────────────────────────────────────┤
│ 选择退货商品                                                     │
│                                                                  │
│ │商品      │原购买│退货数量│入库数量│单价     │退款金额│        │
│ │《三字经》│  10  │ [5]↕️ │ [5]↕️ │RM10.00  │RM50.00 │       │
│ │《论语》  │   5  │ [2]↕️ │ [1]↕️ │RM15.00  │RM30.00 │       │
│ │《孟子》  │   8  │ [0]↕️ │ [0]↕️ │RM12.00  │RM0.00  │       │
│                                                                  │
│ 💡 提示：入库数量可以少于退货数量（如商品损坏无法入库）         │
│                                                                  │
│ 退货原因 *                                                       │
│ ┌────────────────────────────────────────────────────┐          │
│ │ 客户反馈商品有质量问题                              │          │
│ └────────────────────────────────────────────────────┘          │
│                                                                  │
│ 备注                                                             │
│ ┌────────────────────────────────────────────────────┐          │
│ │ 已检查，确实有印刷错误                              │          │
│ └────────────────────────────────────────────────────┘          │
│                                                                  │
│ ┌────────────────────────────────────────┐                      │
│ │ 退款总额: RM80.00                       │                      │
│ └────────────────────────────────────────┘                      │
│                                                                  │
│                              [取消]  [创建退货单]                │
└──────────────────────────────────────────────────────────────────┘
```

### 退货单详情

```
┌──────────────────────────────────────────────────────────────────┐
│ 退货单详情                                                   ✕   │
├──────────────────────────────────────────────────────────────────┤
│ 退货单号: RF202410-001               状态: [已批准]              │
│ 关联发票: INV202410-001             客户: 张三                   │
│ 创建人: 收银员小李                   创建时间: 2024-10-15 10:00  │
│ 审批人: 经理                         审批时间: 2024-10-15 11:30  │
├──────────────────────────────────────────────────────────────────┤
│ 退货商品                                                         │
│ │商品      │退货数量│入库数量│单价     │退款金额│              │
│ │《三字经》│   5    │   5    │RM10.00  │RM50.00 │              │
│ │《论语》  │   2    │   1    │RM15.00  │RM30.00 │              │
│                                                                  │
│ 退货原因: 客户反馈商品有质量问题                                 │
│ 备注: 已检查，确实有印刷错误                                     │
│                                                                  │
│ ┌────────────────────────────────────────┐                      │
│ │ 退款总额: RM80.00                       │                      │
│ └────────────────────────────────────────┘                      │
│                                                                  │
│                                                      [关闭]      │
└──────────────────────────────────────────────────────────────────┘
```

---

## 🔐 权限控制

### 角色权限矩阵

| 功能 | 老板 | 经理 | 收银员 | 仓管员 | 员工 |
|------|------|------|--------|--------|------|
| 查看退货单 | ✅ | ✅ | ✅ | ✅ | ✅ |
| 创建退货单 | ✅ | ✅ | ✅ | ❌ | ❌ |
| 审批退货 | ✅ | ✅ | ❌ | ❌ | ❌ |
| 完成退货 | ✅ | ✅ | ❌ | ✅ | ❌ |

**权限说明：**

**收银员：**
- ✅ 可以创建退货单（处理客户退货）
- ❌ 不能审批（需要上级审批）
- ❌ 不能完成（需要仓管实际入库）

**仓管员：**
- ✅ 可以查看退货单
- ❌ 不能创建（不负责前台业务）
- ❌ 不能审批（不是审批角色）
- ✅ 可以完成（负责实际入库操作）

**经理/老板：**
- ✅ 全部权限

---

## 💡 实际应用场景

### 场景1：商品质量问题

```
情况：
客户购买10本《三字经》，发现2本有印刷错误

流程：
1. 收银员创建退货单
   - 选择发票：INV202410-001
   - 退货数量：2
   - 入库数量：0（有质量问题不能再卖）
   - 原因：印刷错误

2. 经理审批
   - 查看情况
   - 点击"批准"

3. 财务处理
   - 自动退款：2本的钱
   - 发票已付金额减少

4. 库存处理
   - 不增加库存（损坏商品）
   - 记录为退货但不入库

结果：
✅ 客户收到退款
✅ 库存不变（因为入库数量=0）
✅ 完整记录追溯
```

### 场景2：客户不满意

```
情况：
客户购买5本书，看后觉得内容不合适，要退货

流程：
1. 收银员创建退货单
   - 退货数量：5
   - 入库数量：5（商品完好）
   - 原因：客户不满意

2. 经理审批
   - 评估是否在退货期内
   - 点击"批准"

3. 仓管完成
   - 实际收到5本书
   - 检查商品状况
   - 点击"完成退货"

结果：
✅ 库存自动+5
✅ 客户收到退款
✅ 商品可以继续销售
```

### 场景3：订单错误

```
情况：
订单开错，客户要求全部退货

流程：
1. 收银员创建退货单
   - 选择错误的发票
   - 全部商品退货
   - 原因：订单错误

2. 经理审批
   - 确认是工作失误
   - 批准退货

3. 仓管完成
   - 商品全部入库
   - 完成退货

4. 重新开单
   - 给客户开正确的单
   - 重新结账

结果：
✅ 错误订单全部退回
✅ 库存恢复
✅ 重新开正确订单
```

---

## 📊 退货单编号规则

### 格式：RF年份月份-流水号

**示例：**
- RF202410-001 - 2024年10月第1张
- RF202410-025 - 2024年10月第25张
- RF202411-001 - 2024年11月第1张（重新开始）

**特点：**
- RF = Refund（退货）
- 每月从001开始
- 3位数字，最多999张/月
- 与发票号格式一致

---

## 🎯 数据完整性

### 关联数据

**一张退货单关联：**
1. **发票** - 来源发票
2. **客户** - 退货客户
3. **商品** - 退货商品列表
4. **库存变动** - 每个商品的库存记录
5. **操作日志** - 所有操作记录

**数据追溯：**
```
从退货单 → 找到发票
从发票 → 找到所有退货单
从商品 → 找到所有退货记录
从操作日志 → 找到谁创建/审批/完成
```

---

## ⚠️ 注意事项

### 1. 退货数量 vs 入库数量

**关键区别：**
- **退货数量** = 客户实际退回的数量
- **入库数量** = 可以重新销售的数量

**为什么不同？**
- 商品损坏
- 商品污损
- 包装破损
- 过期商品

**示例：**
```
退货：10本书
检查后发现：
- 8本完好 → 入库
- 2本损坏 → 不入库

设置：
- 退货数量：10
- 入库数量：8

结果：
- 退款：10本的钱
- 库存：+8本
```

### 2. 审批流程的重要性

**为什么需要审批？**
- ✅ 防止随意退货
- ✅ 检查退货原因是否合理
- ✅ 评估商品状况
- ✅ 控制退款金额

**哪些情况可能被拒绝？**
- 超过退货期限
- 商品已使用
- 无正当理由
- 商品缺失配件

### 3. 库存恢复时机

**重要：**
- ❌ 创建退货单时不恢复
- ❌ 审批通过时不恢复
- ✅ **完成退货时才恢复**

**原因：**
- 避免虚增库存
- 等待实际收到商品
- 确认商品可用状态

---

## 📈 报表统计

### 退货统计

**可统计指标：**
- 退货单总数
- 各状态数量
- 退款总金额
- 退货率（退货/销售）
- 常见退货原因
- 退货高峰时段

**示例报表：**
```
本月退货统计（2024年10月）
────────────────────────
退货单总数：15张
待审批：3张
已批准：2张
已完成：8张
已拒绝：2张

退款总额：RM1,200.00
退货率：3.5%

主要原因：
1. 商品质量问题（40%）
2. 客户不满意（35%）
3. 订单错误（25%）
```

---

## 🚀 立即体验

系统正在运行：**http://localhost:3004/**

**测试流程：**

1. **登录系统**
   ```
   用户名: admin
   密码: admin123
   ```

2. **创建测试发票**
   ```
   开单管理 → 创建发票
   → 添加商品、客户
   → 提交并付款
   ```

3. **创建退货单**
   ```
   退货管理 → 创建退货单
   → 选择刚才的发票
   → 填写退货信息
   → 提交
   ```

4. **审批退货**
   ```
   找到待审批的退货单
   → 点击✅批准
   ```

5. **完成退货**
   ```
   找到已批准的退货单
   → 点击📦完成退货
   → 查看库存变化
   ```

---

## 📝 总结

**退货管理系统已完整实现：**
- ✅ 完整的退货流程
- ✅ 三级状态流转
- ✅ 智能库存恢复
- ✅ 自动退款计算
- ✅ 权限精细控制
- ✅ 完整操作日志
- ✅ 灵活的入库控制

**业务价值：**
- 🎯 提升客户满意度
- 🎯 规范退货流程
- 🎯 防止退货损失
- 🎯 数据完整可追溯

**退货管理系统，让退货处理更专业！** 🔄✨

